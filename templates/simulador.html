<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Simulador de Tiro</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(to bottom, #2b2d42, #1a1b26);
            color: #edf2f4;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h2 {
            margin-top: 5px;
            color: #f4f4f4;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        
        .simulador-wrapper {
            display: flex;
            align-items: center;
            gap: 50px;
            margin-top: 30px;
            justify-content: flex-start;    /* Para que todo quede alineado a la izquierda */
            width: 100%;
            max-width: 1100px;              /* Puedes aumentar para que haya espacio a la izquierda */
            padding-left: 40px;             /* Mueve todo un poco a la derecha dejando m치s espacio a la izquierda */
        }

        .logo-pistola {
            max-width: 200px;  /* M치s grande */
            opacity: 1;        /* Normal, sin transparencia */
            filter: none;      /* Sin sombra ni efectos */
            user-select: none;
            pointer-events: none;
            transform: scaleX(-1);
        }


        canvas {
            border: 2px solid #8d99ae;
            border-radius: 10px;
            background-color: #ffffff;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: #ef233c;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            box-shadow: 0px 4px 8px rgba(0,0,0,0.4);
        }

        .logout-btn:hover {
            background-color: #d90429;
            transform: scale(1.05);
        }

        #marcador {
            margin-top: 15px;
            background: rgba(0, 255, 0, 0.1);
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 1.2rem;
            max-width: 600px;
            text-align: center;
        }

        @media (max-width: 700px) {
            .simulador-wrapper {
                flex-direction: column;
                gap: 20px;
            }
            .logo-pistola {
                max-width: 100px;
            }
            canvas {
                width: 90vw !important;
                height: 90vw !important;
            }
        }
        #panel-puntos {
            background: rgba(0,0,0,0.3);
            padding: 15px 20px;
            border-radius: 10px;
            min-width: 200px;
            font-size: 1rem;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        #panel-puntos h3 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #06d6a0;
        }
        #panel-puntos p {
            margin: 8px 0;
        }
        #tabla-historial {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.9rem;
            background: rgba(255,255,255,0.05);
        }

        #tabla-historial th, #tabla-historial td {
            border: 1px solid #8d99ae;
            padding: 5px 8px;
            text-align: center;
        }

        #tabla-historial th {
            background: rgba(255,255,255,0.15);
            color: #edf2f4;
        }

        #tabla-historial tr:nth-child(even) {
            background: rgba(0,0,0,0.2);
        }
        #btn-reset {
            margin-top: 12px;
            background: #ef233c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: background 0.3s ease;
            width: 100%;
        }

        #btn-reset:hover {
            background: #d90429;
        }
    </style>
</head>
<body>
    <audio id="sonido-disparo" src="/static/sounds/disparo.mp3" preload="auto"></audio>
    <!-- Bot칩n de cerrar sesi칩n -->
    <a href="{{ url_for('logout') }}" class="logout-btn">游뛁 Cerrar sesi칩n</a>

    <h2 style="text-align: center;">
        SIMULADOR DE TIRO ARMADA BOLIVIANA<br>
        <span style="display: block; font-size: 1.2rem; margin-top: 5px;">Pistola 9 mm</span>
    </h2>

    <div class="simulador-wrapper">
        <img src="/static/images/pistola.png" alt="Pistola" class="logo-pistola" />
        <canvas id="tiro" width="500" height="500"></canvas>
        <!-- 游늵 Panel lateral de estad칤sticas -->
        <div id="panel-puntos">
            <h3>游늵 Estad칤sticas</h3>
            <p id="contador-tiros">Tiros realizados: 0</p>
            <p id="total-puntos">Total puntos: 0</p>
            <p id="ultimo-puntos">칔ltimo tiro: 0</p>
            <!-- 游닆 Historial de tiros -->
            <h4>Historial de tiros</h4>
            <table id="tabla-historial">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Puntos</th>
                        <th>Posici칩n (x,y)</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Se van agregando filas con cada tiro -->
                </tbody>
            </table>
            <button id="btn-reset">游댃 Reiniciar marcador</button>
        </div>
    </div>

    <div id="marcador"></div>

    <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.0/socket.io.min.js"></script>
    <script src="/static/js/simulador_tecla.js"></script>

    <script>
        const socket = io();

        let tiros = 0;
        let totalPuntos = 0;

        // 游꿢 Funci칩n para dibujar el blanco completo con numeraci칩n
        function dibujarBlanco() {
            const canvas = document.getElementById('tiro');
            const ctx = canvas.getContext('2d');

            ctx.clearRect(0, 0, canvas.width, canvas.height); // limpiar canvas

            const cx = canvas.width / 2;
            const cy = canvas.height / 2;

            for (let i = 10; i >= 1; i--) {
                const radio = i * 20; // cada c칤rculo 20px m치s grande
                let color = '';
                switch(i) {
                    case 10: color = '#e6e5e3ff'; break; // dorado
                    case 9:  color = '#e6e5e3ff'; break;
                    case 8:  color = '#e6e5e3ff'; break;
                    case 7:  color = '#e6e5e3ff'; break;
                    case 6:  color = '#e6e5e3ff'; break;
                    case 5:  color = '#e6e5e3ff'; break;
                    case 4:  color = '#e6e5e3ff'; break;
                    case 3:  color = '#e6e5e3ff'; break;
                    case 2:  color = '#e6e5e3ff'; break;
                    case 1:  color = '#e6e5e3ff'; break;
                }

                // Dibujar c칤rculo
                ctx.beginPath();
                ctx.arc(cx, cy, radio, 0, Math.PI * 2);
                ctx.fillStyle = color;
                ctx.fill();
                ctx.strokeStyle = 'black';
                ctx.stroke();

                // Escribir n칰mero dentro del c칤rculo
                ctx.fillStyle = 'black';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(11 - i, cx, cy - radio + 15); // ajustamos vertical para que se vea
            }
        }

        // Dibujar blanco al cargar la p치gina
        window.onload = dibujarBlanco;

        // Evento cuando llega un disparo
        socket.on('nuevo_disparo', data => {
            const canvas = document.getElementById('tiro');
            const ctx = canvas.getContext('2d');

            const cx = canvas.width / 2;
            const cy = canvas.height / 2;

            const dx = data.x - cx;
            const dy = data.y - cy;
            const dist = Math.sqrt(dx*dx + dy*dy);

            // Calcular puntos seg칰n el c칤rculo
            let puntos = 0;
            if (dist <= 200) {
                puntos = 10 - Math.floor(dist / 20); // cada 20px reduce 1 punto
            } else {
                puntos = 0; // fuera del blanco
            }

            // Dibujar disparo
            ctx.beginPath();
            ctx.arc(data.x, data.y, 5, 0, Math.PI * 2);
            ctx.fillStyle = 'red';
            ctx.fill();

            // Reproducir sonido
            const sonido = document.getElementById("sonido-disparo");
            sonido.currentTime = 0;
            sonido.play();

            // Actualizar estad칤sticas
            tiros++;
            totalPuntos += puntos;

            document.getElementById('contador-tiros').textContent = `Tiros realizados: ${tiros}`;
            document.getElementById('total-puntos').textContent = `Total puntos: ${totalPuntos}`;
            document.getElementById('ultimo-puntos').textContent = `칔ltimo tiro: ${puntos}`;

            // Agregar fila al historial
            const tabla = document.querySelector("#tabla-historial tbody");
            const fila = document.createElement("tr");
            fila.innerHTML = `
                <td>${tiros}</td>
                <td>${puntos}</td>
                <td>(${data.x}, ${data.y})</td>
            `;
            tabla.appendChild(fila);
        });

        // Reiniciar solo estad칤sticas y tabla, dejando los c칤rculos
        document.getElementById("btn-reset").addEventListener("click", () => {
            tiros = 0;
            totalPuntos = 0;

            document.getElementById('contador-tiros').textContent = `Tiros realizados: 0`;
            document.getElementById('total-puntos').textContent = `Total puntos: 0`;
            document.getElementById('ultimo-puntos').textContent = `칔ltimo tiro: 0`;

            document.querySelector("#tabla-historial tbody").innerHTML = "";

            dibujarBlanco(); // redibujar todos los c칤rculos con n칰meros
        });
    </script>



</body>
</html>
